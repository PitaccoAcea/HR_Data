{% extends 'base.html' %}
{% load static %}

{% block title %}{{ page_title }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
.menu-tree {
  border: 1px solid #ddd;
  border-radius: 8px;
  background: white;
}

.menu-item-row {
  padding: 12px 15px;
  border-bottom: 1px solid #eee;
  display: flex;
  align-items: center;
  justify-content: space-between;
  transition: background-color 0.2s;
}

.menu-item-row:hover {
  background-color: #f8f9fa;
}

.menu-item-row:last-child {
  border-bottom: none;
}

.menu-item-info {
  display: flex;
  align-items: center;
  flex: 1;
}

.menu-item-title {
  font-weight: 500;
  margin-right: 10px;
}

.menu-item-url {
  color: #6c757d;
  font-size: 0.9em;
  margin-right: 10px;
}

.menu-item-groups {
  font-size: 0.85em;
  color: #28a745;
}

.menu-item-actions {
  display: flex;
  gap: 8px;
}

.btn-sm {
  padding: 4px 8px;
  font-size: 0.85em;
}

.menu-level {
  margin-right: 10px;
  color: #6c757d;
}

.menu-level-0 { padding-left: 0; }
.menu-level-1 { padding-left: 20px; }
.menu-level-2 { padding-left: 40px; }
.menu-level-3 { padding-left: 60px; }
.menu-level-4 { padding-left: 80px; }

.inactive-item {
  opacity: 0.6;
}

.inactive-item .menu-item-title {
  text-decoration: line-through;
}

.drag-handle {
  cursor: move;
  color: #6c757d;
  margin-right: 10px;
}

.sortable-ghost {
  opacity: 0.4;
}

.sortable-chosen {
  background-color: #e3f2fd !important;
}

.stats-cards {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 20px;
  margin-bottom: 30px;
}

.stat-card {
  background: white;
  padding: 20px;
  border-radius: 8px;
  border: 1px solid #ddd;
  text-align: center;
}

.stat-number {
  font-size: 2em;
  font-weight: bold;
  color: #007bff;
}

.stat-label {
  color: #6c757d;
  margin-top: 5px;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="row">
    <div class="col-12">
      <!-- Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>
          <i class="fas fa-bars me-2"></i>
          {{ page_title }}
        </h1>
        <div>
          <a href="{% url 'menu_preview' %}" class="btn btn-info me-2" target="_blank">
            <i class="fas fa-eye"></i> Anteprima
          </a>
          <a href="{% url 'menu_voce_new' %}" class="btn btn-success">
            <i class="fas fa-plus"></i> Nuova Voce
          </a>
        </div>
      </div>

      <!-- Statistiche -->
      <div class="stats-cards">
        <div class="stat-card">
          <div class="stat-number">{{ menu_tree|length }}</div>
          <div class="stat-label">Voci Totali</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{% for item in menu_tree %}{% if item.attivo %}1{% endif %}{% empty %}0{% endfor %}</div>
          <div class="stat-label">Voci Attive</div>
        </div>
        <div class="stat-card">
          <div class="stat-number">{{ gruppi|length }}</div>
          <div class="stat-label">Gruppi</div>
        </div>
      </div>

      <!-- Albero del menù -->
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-sitemap me-2"></i>
            Struttura Menù
            <small class="text-muted ms-2">(Trascina per riordinare)</small>
          </h5>
        </div>
        <div class="card-body p-0">
          {% if menu_tree %}
            <div class="menu-tree" id="menu-tree">
              {% for item in menu_tree %}
                <div class="menu-item-row menu-level-{{ item.level }} {% if not item.attivo %}inactive-item{% endif %}" 
                     data-id="{{ item.id }}" data-level="{{ item.level }}">
                  <div class="menu-item-info">
                    <i class="fas fa-grip-vertical drag-handle"></i>
                    
                    <!-- Indicatore di livello -->
                    <span class="menu-level">
                      {% for i in "x"|rjust:item.level %}▸{% endfor %}
                    </span>

                    <!-- Icona -->
                    {% if item.icona %}
                      <span class="me-2">{{ item.get_icona_html|safe }}</span>
                    {% endif %}

                    <!-- Titolo e URL -->
                    <div>
                      <span class="menu-item-title">{{ item.titolo }}</span>
                      <span class="menu-item-url">({{ item.url }})</span>
                      
                      <!-- Gruppi autorizzati -->
                      {% if item.gruppi_autorizzati.exists %}
                        <div class="menu-item-groups">
                          <i class="fas fa-users fa-sm"></i>
                          {% for gruppo in item.gruppi_autorizzati.all %}
                            <span class="badge bg-success me-1">{{ gruppo.nome }}</span>
                          {% endfor %}
                        </div>
                      {% else %}
                        <div class="menu-item-groups">
                          <i class="fas fa-globe fa-sm"></i>
                          <span class="badge bg-secondary">Pubblico</span>
                        </div>
                      {% endif %}
                    </div>
                  </div>

                  <!-- Azioni -->
                  <div class="menu-item-actions">
                    <!-- Toggle attivo/inattivo -->
                    <form method="post" action="{% url 'menu_toggle_active' item.id %}" style="display: inline;">
                      {% csrf_token %}
                      <button type="submit" 
                              class="btn btn-sm {% if item.attivo %}btn-warning{% else %}btn-success{% endif %}"
                              title="{% if item.attivo %}Disattiva{% else %}Attiva{% endif %}">
                        <i class="fas {% if item.attivo %}fa-eye-slash{% else %}fa-eye{% endif %}"></i>
                      </button>
                    </form>

                    <!-- Modifica -->
                    <a href="{% url 'menu_voce_edit' item.id %}" 
                       class="btn btn-sm btn-primary" title="Modifica">
                      <i class="fas fa-edit"></i>
                    </a>

                    <!-- Elimina -->
                    <a href="{% url 'menu_voce_delete' item.id %}" 
                       class="btn btn-sm btn-danger" title="Elimina">
                      <i class="fas fa-trash"></i>
                    </a>
                  </div>
                </div>
              {% endfor %}
            </div>
          {% else %}
            <div class="text-center py-5">
              <i class="fas fa-bars fa-3x text-muted mb-3"></i>
              <h5 class="text-muted">Nessuna voce di menù</h5>
              <p class="text-muted">Inizia creando la prima voce del menù</p>
              <a href="{% url 'menu_voce_new' %}" class="btn btn-success">
                <i class="fas fa-plus"></i> Crea Prima Voce
              </a>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const menuTree = document.getElementById('menu-tree');
    if (menuTree) {
        // Inizializza Sortable per drag & drop
        Sortable.create(menuTree, {
            handle: '.drag-handle',
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            onEnd: function(evt) {
                // Raccoglie il nuovo ordine
                const updates = [];
                const items = menuTree.querySelectorAll('.menu-item-row');
                
                items.forEach((item, index) => {
                    updates.push({
                        id: parseInt(item.dataset.id),
                        ordine: index
                    });
                });

                // Invia la richiesta AJAX per aggiornare l'ordine
                fetch('{% url "menu_reorder" %}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({updates: updates})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Mostra messaggio di successo
                        showMessage('success', data.message);
                    } else {
                        showMessage('error', data.error);
                        // Ricarica la pagina in caso di errore
                        location.reload();
                    }
                })
                .catch(error => {
                    console.error('Errore:', error);
                    showMessage('error', 'Errore durante il riordinamento');
                    location.reload();
                });
            }
        });
    }

    // Funzione per mostrare messaggi
    function showMessage(type, message) {
        const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
        const alertHtml = `
            <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
                <i class="fas ${type === 'success' ? 'fa-check' : 'fa-exclamation-triangle'}"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        // Inserisce l'alert all'inizio del contenuto
        const container = document.querySelector('.container-fluid');
        container.insertAdjacentHTML('afterbegin', alertHtml);
        
        // Rimuove automaticamente dopo 3 secondi
        setTimeout(() => {
            const alert = container.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 3000);
    }
});
</script>
{% endblock %}